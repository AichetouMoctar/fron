<div class="page">

  <!-- LISTE DES LIGNES -->
  <div class="list-panel" [class.hidden-mobile]="selectedLigne">
    <div class="page-header">
      <h1><i class="fas fa-route"></i> Lignes de transport</h1>
      <p>{{ filteredLignes.length }} ligne(s)</p>
    </div>

    <div class="search-bar">
      <i class="fas fa-search"></i>
      <input type="text" [(ngModel)]="searchQuery" (input)="onSearch()"
             placeholder="Rechercher une ligne...">
    </div>

    @if (isLoading) {
      <div class="loading"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>
    }

    <div class="lines-list">
      @for (ligne of filteredLignes; track ligne.id) {
        <div class="line-card" [class.active]="selectedLigne?.id === ligne.id"
             (click)="onSelectLigne(ligne)">
          <div class="line-badge" [style.background]="ligne.couleur || '#3b82f6'">
            {{ ligne.code || 'L' }}
          </div>
          <div class="line-info">
            <strong>{{ ligne.nom }}</strong>
            <span class="line-route">{{ ligne.arretDepartNom || '—' }} → {{ ligne.arretArriveeNom || '—' }}</span>
            @if (ligne.nombreArrets) {
              <span class="line-stops-count">{{ ligne.nombreArrets }} arrêts</span>
            }
          </div>
          <i class="fas fa-chevron-right arrow-icon"></i>
        </div>
      }
    </div>

    @if (!isLoading && filteredLignes.length === 0) {
      <div class="empty"><i class="fas fa-search"></i><p>Aucune ligne trouvée</p></div>
    }
  </div>

  <!-- DÉTAIL D'UNE LIGNE -->
  @if (selectedLigne) {
    <div class="detail-panel">
      <!-- Header -->
      <div class="detail-back" (click)="closeDetail()">
        <i class="fas fa-arrow-left"></i> Retour
      </div>

      <div class="detail-header" [style.border-left-color]="selectedLigne.couleur || '#3b82f6'">
        <div class="line-badge large" [style.background]="selectedLigne.couleur || '#3b82f6'">
          {{ selectedLigne.code || 'L' }}
        </div>
        <div>
          <h2>{{ selectedLigne.nom }}</h2>
          <span>{{ selectedLigne.arretDepartNom || '—' }} → {{ selectedLigne.arretArriveeNom || '—' }}</span>
        </div>
      </div>

      <!-- Itinéraire -->
      <section class="card">
        <h3><i class="fas fa-map-signs"></i> Itinéraire ({{ arrets.length }} arrêts)</h3>
        <div class="timeline">
          @for (a of arrets; track a.arretId; let first = $first; let last = $last) {
            <div class="timeline-item" [class.first]="first" [class.last]="last"
                 (click)="onSelectStop(a.arretId)">
              <div class="timeline-dot"
                   [style.border-color]="selectedLigne.couleur || '#3b82f6'"
                   [style.background]="first || last ? (selectedLigne.couleur || '#3b82f6') : 'white'">
              </div>
              <div class="timeline-content">
                <span class="stop-order">{{ a.ordre }}</span>
                <strong>{{ a.arretNom }}</strong>
                @if (a.dureeMinutes > 0) {
                  <span class="time-badge">{{ a.dureeMinutes }} min</span>
                }
              </div>
            </div>
          }
        </div>
        @if (arrets.length === 0) {
          <p class="no-data">Aucun arrêt enregistré</p>
        }
      </section>

      <!-- Horaires -->
      <section class="card">
        <h3><i class="fas fa-clock"></i> Horaires de départ</h3>
        <div class="horaires-grid">
          @for (h of horaires; track h.id) {
            <div class="horaire-chip">{{ h.heureDepart }}</div>
          }
        </div>
        @if (horaires.length === 0) {
          <p class="no-data">Aucun horaire programmé</p>
        }
      </section>

      <!-- Détail arrêt sélectionné -->
      @if (selectedStopDetails) {
        <section class="card stop-detail">
          <h3><i class="fas fa-info-circle"></i> {{ selectedStopDetails.nom }}</h3>
          <div class="stop-meta">
            @if (selectedStopDetails.code) {
              <div class="meta-item"><span>Code</span><strong>{{ selectedStopDetails.code }}</strong></div>
            }
            <div class="meta-item"><span>Latitude</span><strong>{{ selectedStopDetails.latitude }}</strong></div>
            <div class="meta-item"><span>Longitude</span><strong>{{ selectedStopDetails.longitude }}</strong></div>
            @if (selectedStopDetails.adresse) {
              <div class="meta-item"><span>Adresse</span><strong>{{ selectedStopDetails.adresse }}</strong></div>
            }
          </div>
        </section>
      }
    </div>
  }

</div>

